<DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<script>
		var Entity = function(x, y, radius, color){
			this.x = x;
			this.y = y;
			this.r = radius;
			this.col = color;

			this.onTick = function(dt){};
			this.onClick = function(x, y, btn){};
			this.onMouse = function(x, y, btn){};
			this.render = function(ctx){
				ctx.beginPath();
			 	ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI, false);
			 	ctx.fillStyle = this.col;
			 	ctx.fill();
			};
		};		

		KeyState = {PRESS:0, HOLD:1, RELEASE:3, UP:4};

		var canvas;
		var context;
		var entities = [];
		var inputKeys = [];
		for(var i = 0; i < 255; i++){
			inputKeys[i] = KeyState.UP;
		}

		function OnKeyUp(key){
			return inputKeys[key.charCodeAt(0)] === KeyState.RELEASE;
		}

		function OnKeyDown(key){
			return inputKeys[key.charCodeAt(0)] === KeyState.PRESS;
		}

		function OnKey(key){
			//console.log(inputKeys[key]);
			return inputKeys[key.charCodeAt(0)] === KeyState.PRESS || inputKeys[key.charCodeAt(0)] === KeyState.HOLD;
		}

		function EndOfFrameKeys(){
			for(var i = 0; i < 255; i++){
				if(inputKeys[i] === KeyState.PRESS){
					inputKeys[i] = KeyState.HOLD;
				}
				if(inputKeys[i] === KeyState.RELEASE){
					inputKeys[i] = KeyState.UP;
					console.log(inputKeys[i]);
				}
			}
		}
		
		window.onload = function(){
			canvas = document.getElementById("main-canvas");
			context = canvas.getContext("2d");
			if(context === null || context === undefined){
				alert("Your browser does not support 2D canvas rendering.");
				return;
			}

			var newEnt = new Entity(window.innerWidth/2, window.innerHeight - 60, 20, "#ee3388");
			newEnt.pressed = false;
			var speed = 70;
			
			var spawnEntity = function(x, y, player){
				var entSpawn = new Entity(x, y, 16, "#ccc");
				entSpawn.player = player;
				entSpawn.runAway = false;
				entSpawn.onTick = function(dt){
					var playerDist = Math.sqrt(Math.pow(this.x - this.player.x, 2) + Math.pow(this.y - this.player.y, 2));
					if(playerDist < 80){
						this.runAway = true;
					}
					else if(playerDist > 120){
						this.runAway = false;
					}
					
					if(this.runAway){
						//console.log("Running away");
						var moveX = (this.x - this.player.x) / playerDist;
						var moveY = (this.y - this.player.y) / playerDist;
						this.x += moveX * dt * speed * 1.5;
						this.y += moveY;
						//return;
					}
					
					for(var idx in entities){
						if(entities[idx] === this || entities[idx] === this.player){
							continue;
						}
						var dist = Math.sqrt(Math.pow(this.x - entities[idx].x, 2) + Math.pow(this.y - entities[idx].y, 2));
						if(dist < (this.r + entities[idx].r) && dist > 2){
							var moveX = (this.x - entities[idx].x) / dist;
							var moveY = (this.y - entities[idx].y) / dist;
							this.x += moveX;
							this.y += moveY;
							//console.log("Move away");
						}	
					}
				};
				entities.push(entSpawn);
			};
			
			/*
			for(var i = 0; i < 20; i++){
				spawnEntity((0.4*Math.random() + 0.2) * window.innerWidth, (0.4*Math.random() + 0.2) * window.innerHeight, newEnt);
			}
			*/
			
			if(typeof variable !== 'undefined'){
				for(var idx in entityTable){
					spawnEntity(entityTable[idx].x * window.innerWidth, entityTable[idx].y * window.innerHeight, newEnt);
				}
			}
			
			newEnt.onTick = function(dt){
				if(OnKey("W") || OnKey("&")){
					this.y -= dt * speed;
				}
				if(OnKey("S") || OnKey("(")){
					this.y += dt * speed;
				}
				if(OnKey("A") || OnKey("%")){
					this.x -= dt * speed;
				}
				if(OnKey("D") || OnKey("'")){
					this.x += dt * speed;
				}
				
				if(OnKey("T")){
					if(!pressed){
						spawnEntity(this.x, this.y+20, this);
						pressed = true;
					}
				}
				else{
					pressed = false;
				}
			};
			entities.push(newEnt);

			document.onkeydown = function(evt){
				var key = evt.which || evt.keyCode;
				inputKeys[key] = KeyState.PRESS;
			};

			document.onkeyup = function(evt){
				var key = evt.which || evt.keyCode;
				inputKeys[key] = KeyState.RELASE;
			};

			setInterval(function(){GameLoop(0.017);}, 17);
		};

		function GameLoop(dt){
			for(var idx in entities){
				entities[idx].onTick(dt);
			}

			RenderScene(context);

			EndOfFrameKeys();
		}

		function RenderScene(ctx){
			ctx.canvas.width  = window.innerWidth;
  			ctx.canvas.height = window.innerHeight;
			ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
			for(var idx in entities){
				entities[idx].render(ctx);
			}
		}
	</script>
</head>
<body style="background:#444;">
	<canvas style="width:100%;height:100%;margin:-8px;" id="main-canvas">
		<p>Sorry, looks like your browser doesn't support canvas rendering.</p>
	</cavas>
</body>
</html>
