<DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<script>
		var Entity = function(x, y, radius, color){
			this.x = x;
			this.y = y;
			this.r = radius;
			this.col = color;

			this.onTick = function(dt){};
			this.onClick = function(x, y, btn){};
			this.onMouse = function(x, y, btn){};
			this.render = function(ctx){
				ctx.beginPath();
			 	ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI, false);
			 	ctx.fillStyle = this.col;
			 	ctx.fill();
			};
		};		

		KeyState = {PRESS:0, HOLD:1, RELEASE:3, UP:4};

		var canvas;
		var context;
		var entities = [];
		var inputKeys = [];
		for(var i = 0; i < 255; i++){
			inputKeys[i] = KeyState.UP;
		}

		function OnKeyUp(key){
			return inputKeys[key.charCodeAt(0)] === KeyState.RELEASE;
		}

		function OnKeyDown(key){
			return inputKeys[key.charCodeAt(0)] === KeyState.PRESS;
		}

		function OnKey(key){
			//console.log(inputKeys[key]);
			return inputKeys[key.charCodeAt(0)] === KeyState.PRESS || inputKeys[key.charCodeAt(0)] === KeyState.HOLD;
		}

		function EndOfFrameKeys(){
			for(var i = 0; i < 255; i++){
				if(inputKeys[i] === KeyState.PRESS){
					inputKeys[i] = KeyState.HOLD;
				}
				if(inputKeys[i] === KeyState.RELEASE){
					inputKeys[i] = KeyState.UP;
					console.log(inputKeys[i]);
				}
			}
		}
		
		window.onload = function(){
			canvas = document.getElementById("main-canvas");
			context = canvas.getContext("2d");
			if(context === null || context === undefined){
				alert("Your browser does not support 2D canvas rendering.");
				return;
			}

			var newEnt = new Entity(30, 60, 10, "#ee3388");
			newEnt.pressed = false;
			var speed = 30;
			
			var spawnEntity = function(x, y, player){
				var entSpawn = new Entity(x, y, 8, "#ccc");
				entSpawn.player = player;
				entSpawn.onTick = function(dt){
					var dist = Math.sqrt(Math.pow(this.x - this.player.x, 2) + Math.pow(this.y - this.player.y, 2));
					if(dist > 50){
						//this.x += (Math.random()*2-1)*10 * dt;
						//this.y += (Math.random()*2-1)*10 * dt;
					}
					else{
						var moveVec = {};
						moveVec.x = (this.x - this.player.x) / dist;
						moveVec.y = (this.y - this.player.y) / dist;
						this.x += moveVec.x * speed * dt * 1.5;
						this.y += moveVec.y * speed * dt * 1.5;
					}
				};
				entities.push(entSpawn);
			};
			
			for(var i = 0; i < 300; i++){
				spawnEntity((0.8*Math.random() + 0.1) * window.innerWidth, (0.8*Math.random() + 0.1) * window.innerHeight, newEnt);
			}
			
			newEnt.onTick = function(dt){
				if(OnKey("W") || OnKey("&")){
					this.y -= dt * speed;
				}
				if(OnKey("S") || OnKey("(")){
					this.y += dt * speed;
				}
				if(OnKey("A") || OnKey("%")){
					this.x -= dt * speed;
				}
				if(OnKey("D") || OnKey("'")){
					this.x += dt * speed;
				}
				
				if(OnKey("T")){
					if(!pressed){
						spawnEntity(this.x, this.y+20, this);
						pressed = true;
					}
				}
				else{
					pressed = false;
				}
			};
			entities.push(newEnt);

			document.onkeydown = function(evt){
				var key = evt.which || evt.keyCode;
				inputKeys[key] = KeyState.PRESS;
			};

			document.onkeyup = function(evt){
				var key = evt.which || evt.keyCode;
				inputKeys[key] = KeyState.RELASE;
			};

			setInterval(function(){GameLoop(0.033);}, 33);
		};

		function GameLoop(dt){
			for(var idx in entities){
				entities[idx].onTick(dt);
			}

			RenderScene(context);

			EndOfFrameKeys();
		}

		function RenderScene(ctx){
			ctx.canvas.width  = window.innerWidth;
  			ctx.canvas.height = window.innerHeight;
			ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
			for(var idx in entities){
				entities[idx].render(ctx);
			}
		}
	</script>
</head>
<body style="background:#444;">
	<canvas style="width:100%;height:100%;margin:-8px;" width="600px" height="800px" id="main-canvas">
		<p>Sorry, looks like your browser doesn't support canvas rendering.</p>
	</cavas>
</body>
</html>
